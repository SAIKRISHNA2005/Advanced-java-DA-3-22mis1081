<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <ui:composition template="/templates/layout.xhtml">
        <ui:define name="title">Manage Users</ui:define>

        <ui:define name="content">
            <f:metadata>
                <f:event type="preRenderView" listener="#{studentBean.loadAllStudents}"/>
            </f:metadata>

            <ui:fragment rendered="#{studentBean.admin}">
                <div class="card">
                    <h2>ðŸ‘¥ User Management</h2>
                    <p style="color: #555 !important; margin-bottom: 20px;">
                        View and manage registered learners. Administrators are hidden from this list to keep their accounts safe.
                    </p>
                    <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;">
                        <div class="stat-card" style="flex: 1 1 200px;">
                            <div class="stat-value">#{studentBean.managedStudents.size()}</div>
                            <div class="stat-label">Active Learners</div>
                        </div>
                        <div class="stat-card" style="flex: 1 1 200px;">
                            <div class="stat-value">#{enrollmentBean.totalEnrollmentsCount}</div>
                            <div class="stat-label">Total Enrollments</div>
                        </div>
                    </div>
                </div>

                <ui:fragment rendered="#{not empty studentBean.managedStudents}">
                    <div class="card">
                        <h3 style="color: #333 !important; margin-bottom: 20px;">Registered Users</h3>
                        <ui:repeat value="#{studentBean.managedStudents}" var="user">
                            <div class="enrollment-item" style="margin-bottom: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap;">
                                    <div style="flex: 1;">
                                        <h3 style="color: var(--primary-color) !important; margin-bottom: 10px;">
                                            #{user.firstName} #{user.lastName}
                                        </h3>
                                        <p style="color: #555 !important; margin: 5px 0;">
                                            <strong>Email:</strong> #{user.email}
                                        </p>
                                        <p style="color: #555 !important; margin: 5px 0;">
                                            <strong>Phone:</strong> #{empty user.phone ? 'Not provided' : user.phone}
                                        </p>
                                        <p style="color: #555 !important; margin: 5px 0;">
                                            <strong>Address:</strong> #{empty user.address ? 'Not provided' : user.address}
                                        </p>
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 10px;">
                                        <h:form>
                                            <h:commandButton value="Remove User"
                                                             action="#{studentBean.deleteStudent}"
                                                             styleClass="button button-danger button-small"
                                                             onclick="return confirm('Remove this user and all related enrollments?');">
                                                <f:param name="studentId" value="#{user.studentId}"/>
                                            </h:commandButton>
                                        </h:form>
                                    </div>
                                </div>
                            </div>
                        </ui:repeat>
                    </div>
                </ui:fragment>

                <ui:fragment rendered="#{empty studentBean.managedStudents}">
                    <div class="card">
                        <div class="empty-state">
                            <p style="font-size: 1.1rem; color: #666 !important;">No learners registered yet.</p>
                            <p style="color: #999 !important; margin-top: 10px;">
                                Students will appear here after they create an account.
                            </p>
                        </div>
                    </div>
                </ui:fragment>
            </ui:fragment>

            <ui:fragment rendered="#{not studentBean.admin}">
                <div class="card">
                    <div class="empty-state">
                        <p style="font-size: 1.2rem; color: #666 !important;">Access Denied</p>
                        <p style="color: #999 !important; margin-top: 10px;">
                            <ui:fragment rendered="#{empty studentBean.currentStudent}">
                                Please login as admin to access this page.
                            </ui:fragment>
                            <ui:fragment rendered="#{not empty studentBean.currentStudent}">
                                You do not have permission to access the admin page. Only administrators can access this page.
                            </ui:fragment>
                        </p>
                        <h:form>
                            <h:commandButton value="Go to Home" action="home"
                                            styleClass="button" style="margin-top: 20px;"/>
                        </h:form>
                    </div>
                </div>
            </ui:fragment>
        </ui:define>
    </ui:composition>
</html>

